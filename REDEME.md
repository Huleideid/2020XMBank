

<center><big><b><font size="6">2020厦门国际银行数创金融杯建模大赛建模总结</font></b></big></center>

赛题链接：https://js.dclab.run/v2/cmptDetail.html?id=439

本文的代码:  https://github.com/Huleideid/2020XMBank

## 1. 赛题分析与理解

### 1.1 赛题背景与目的

​		 随着科技发展，银行陆续打造了线上线下、丰富多样的客户触点，来满足客户日常业务办理、渠道交易等客户需求。面对着大量的客户，银行需要更全面、准确地洞察客户需求。在实际业务开展过程中，需要发掘客户流失情况，对客户的资金变动情况预判；提前/及时针对客户进行营销，减少银行资金流失。

### 1.2 分析与理解

​		**题目目标**是预测客户的资金变动。其中,  label表示的含义，-1 下降、0 维稳、1 提升。通过官方赛题答疑，label是根据一定业务规则和客户aum情况去给客户打标签。因此, 目标也就是利用算法去拟合这个规则。

​		**赛题主要难点**包括 ①数据的高维稀疏性（日期数据空值比例高）导致数据的可利用性降低，给模型学习能力的提升带来了困难；②数据的不平衡，导致模型容易出现过拟合问题；

## 2. 数据预处理与特征工程

### 2.1 数据总体概述

​      数据共分为两个数据集，训练集（train_x.csv、train_target.csv）和测试集。数据集是属于高维特征属性数据，其中数据集包含的属性和特征详细分为以下两种类型：

**(I) 用户基本属性信息**

| 字段名称 | 解释             | 字段名称 | 解释               |
| -------- | ---------------- | -------- | ------------------ |
| cust_no  | 用户唯一id       | I11      | 家庭年收入         |
| I1       | 性别             | I12      | 行业描述           |
| I2       | 年龄             | I13      | 婚姻状况描述       |
| I3       | 客户等级         | I14      | 职务描述           |
| I4       | 本行员工标志     | I15      | 二维码收单客户标志 |
| I5       | 职业描述         | I16      | vip客户标志        |
| I6       | 我行贷款客户标志 | I17      | 网银客户标志       |
| I7       | 本行产品持有数   | I18      | 手机银行客户标志   |
| I8       | 星座描述         | I19      | 短信客户           |
| I9       | 客户贡献度       | I20      | 微信支付客户标志   |
| I10      | 学历描述         |          |                    |

**(II) 用户行为相关的数据**

​	**第Y月的行为数据**

| 字段 | 解释                                        |
| ---- | ------------------------------------------- |
| B1   | Y月登录手机银行网银次数                     |
| B2   | Y月转账转入次数                             |
| B3   | Y月转账转入金额                             |
| B4   | Y月转账转出次数                             |
| B5   | Y月转账转出金额                             |
| B6   | 仅有3、6、9、12月有该数据，最近一次交易时间 |
| B7   | 仅有3、6、9、12月有该数据，季度内动账次数   |

​	**第 Z 季度的客户重大历史数据**

| 字段名称 | 解释                   | 字段名称 | 解释                         |
| -------- | ---------------------- | -------- | ---------------------------- |
| E1       | 开户日期               | E10      | 第一次资金业务交易日期       |
| E2       | 网银开户日期           | E11      | 第一次银证转账日期           |
| E3       | 手机app开户日期        | E12      | 第一次柜台日期               |
| E4       | 第一次网银登陆日期     | E13      | 第一次网银日期               |
| E5       | 第一次手机app登陆日期  | E14      | 第一次手机app转帐日期        |
| E6       | 第一次活期存款业务日期 | E15      | 转出他行最大一笔金额         |
| E7       | 第一次定期存款业务日期 | E16      | 转出他行最大一笔金额发生日期 |
| E8       | 第一次贷款业务日期     | E17      | 他行转入最大一笔金额         |
| E9       | 第一次逾期日期         | E18      | 他行转入最大一笔金额发生日期 |

**(III) 金额数据**

​		**资产数据**

| 字段名称 | 解释                      | 字段名称 | 解释                    |
| -------- | ------------------------- | -------- | ----------------------- |
| X1       | Y月月末时点结构性存款余额 | X5       | Y月月未时点基金余额     |
| X2       | Y月月末时点定期存款余额   | X6       | Y月月末时点资管余额     |
| X3       | Y月月末时点活期存款余额   | X7       | Y月月未时点贷款余额     |
| X4       | Y月月末时点理财余额       | X8       | Y月月末时点大额存单余额 |

​		**存款数据**

| 字段名称 | 解释             |
| -------- | ---------------- |
| C1       | 当前存款产品金额 |
| C2       | 当月存款产品个数 |

### 2.2 特征工程

#### 2.2.1 用户基本属性信息

​		结合EDA数据分析和基础常识，性别I1、年龄I2、星座描述I8(明显没用)，本行员工标志I4(从数据上看没用)，字段I7（全是0）, , 客户贡献度I9(全为nan), 行业描述I12( 无限接近只有一类)用处不大，二维码收单客户标志I15( 大部分只有一类), 网银客户标志I17( 大部分只有一类), 手机银行客户标志I18( 大部分只有一类), 短信客户I19( 大部分只有一类)和。 结合常识和EDA分析，需要关注的字段是客户等级I3, 职业描述I5，我行贷款客户标志I6, 学历描述I10，家庭收入I11、婚姻状况描述I13, 重点关注客户等级I3。

#### 2.2.2 金额相关特征

​		以原始特征为基础，构造以下特征

| 数据源         | 原始特征及构造产生的新特征                                   |
| -------------- | ------------------------------------------------------------ |
| aum.csv        | 结构性存款余额(X1)、定期余额(X2)、活期余额(X3)、理财余额(X4)、基金余额(X5)、资管余额(X6)、贷款余额(X7)、大额存单余额(X8)、净资产X9（X1+ X2+X3+X4+X5+X6-X7+X8）、负债率（X7/X9）、衡量稳定情况（X2/X9） |
| cunkuan.csv    | 存款余额(C1)、产品数(C2)和产品平均存款金额(C1/C2)            |
| behavior_m.csv | Y月净额**B5-B3**(B5-B3), Y月转入金额转出金额比 **B5/B3**(B5/B3） |

**第一期特征工程1：**

​		以用户分组构造上述特征的mean、max、min、std、last的季度范围内的统计。

**第二期特征工程2：**

​		 资产的特征必须围绕变动展开。有季度内的变化和季度间的变化。如果只用一个季度的数据训练做预测，经过试验, kappa值很难上去。 同时，如果使用3，4季度的数据预测3季度的标签的时候，Kappa值非常高（穿越）。综上, 季度间的特征是非常重要的。针对有些用户是当季度新注册的，没有上一季度的数据，可以用0补上一季度数据。

    # 季度内波动
    stat[f+'_3s'] = 当季度末金额   -  当季度初金额 
    stat[f+'_3s'] = 上一季度末金额   -  上一季度初金额 
    # 季度间波动
    stat[f+'_34s'] = 当季度末金额  - 上一季度初金额 
    stat[f+'_45s'] = 当季度末金额  - 上一季度末金额 

#### 2.2.3 日期信息特征

​	构造特征包括

| 数据源     | 原始特征及构造产生的新特征                                   |
| ---------- | ------------------------------------------------------------ |
| behavior_m | B6最近一次交易时间                                           |
| event.csv  | 开户日期（E1)，网银客户日期(E2)，第一次活期存款业务时间(E6)，第一次定期存款业务时间(E7)，第一次贷款业务时间(E8)， 第一次逾期日期(E9)， 第一次资金业务交易日期(E10)， 第一次银证转账日期(E11)， 第一次柜台转账日期(E12)， 第一次网银转账日期(E13)， 第一次手机app转账日期(E14))，转出他行最大一笔金额发生日期(E16)，转入他行最大一笔金额发生日期(E18) |

1. **异常值处理**

​		对于日期数据，针对开户日期(E1)存在异常值1899-12-31， 1900-01-01这两个日期异常值，利用电子银行开户日期(E2)进行替换开户日期(E1)异常的数据。

2. **数值分箱及缺失值处理**

​        为了避免模型过拟合以及增加模型的泛化能力，这里对时期数据进行数值分箱。根据发生时间在当季度、上一个季度、上一个季度、很远等进行5类分箱。

#### 2.2.4  其他特征

​		利用上季度的标签-1,0,1作为特征。对于上季度缺失的情况，如果是本季度新注册，编码为2，否则编码为3

## **3.  模型**

### **3.1 模型效率评估指标**

​	Kappa系数是一个用于一致性检验的指标，也可以用于衡量分类的效果。因为对于分类问题，所谓一致性就是模型预测结果和实际分类结果是否一致。kappa系数的计算是基于混淆矩阵的，取值为-1到1之间,通常大于0。

​    基于混淆矩阵的kappa系数计算公式如下：

​				$$\text {kappa}=\frac{p_{o}-p_{e}}{1-p_{e}}$$

其中$p_{o}=\frac{\text { 对角线元素之和 }}{\text { 整个矩阵元素之和 }}$, 也就是acc。 $p_{e}=\frac{\sum_{i} \text { 第 } i \text { 行元素之和 } * \text { 第 } i \text { 列元素之和 }}{\left(\sum \text { 矩阵所有元素 }\right)^{2}}$，即所有类别分别对应的“实际与预测数量的乘积”之总和，除以“样本总数的平方”。

### **3.2 模型框架**



![模型框架图](.\图\模型框架图.png)

​		 

​		这里的后处理采用加类别权重的训练方式进行训练，权重系数直接采用[2]，据说是搜索得到，细节有待补充。当然也可以参考[4]，亲测有效。由于赛后重新整理了程序，做了一些新的特征，最新的提交结果未测，估计二者单独均在0.49左右，单LGM线下更高。由于LGB和CATBOOST的特征完全相同，两者融合可能并不能带来提升。

## 4. 心得体会

- 特征是最重要的提分点，应结合专业知识和数据分析综合来做特征。对于与实际业务相关的任务，尽量避免做一些没有实际意义的统计特征。
- 当模型的loss指标和评估指标不一致时，数据后处理是一个非常好的的提分点。
- 把握好特征工程的尺度。在时间有限和非专业背景的情况下，有些处理收益比较小，建议选择好方向。

**一些未成功的尝试**

- 对不同等级的用户分组预测。尝试后效果不太好，细节可能还需要注意。
- 由于利用第三季度和第四季度的特征预测第三季度的标签，可以发现预测结果较好。因此, 我们尝试通过这种方式，预测得到第五季度新增加的有效用户的第四季度的标签，但实际效果非常不好。思考分析了一下，对于第五季度新增加的有效用户，本来第四季度就没标签，这样做本身是没有意义的，或者说不合理的。

## 参考

[1] [2020厦门国际银行数创金融杯建模大赛Top开源——纯干货附代码](https://mp.weixin.qq.com/s/FHzFItwswMPu3D_HenJbcg)

[2] https://github.com/BirderEric/XianmenBank

[3] [2020厦门国际银行数创金融杯建模大赛Baseline](https://mp.weixin.qq.com/s/Y9bDEtQS94HkWxHOI8hYVw)

[4] [浅谈模型预测结果的优化方法](https://mp.weixin.qq.com/s/pLxLCJDtpllid3GsgxLwwA)